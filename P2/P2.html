<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>P2: Vehicle Availability</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="P2_files/libs/clipboard/clipboard.min.js"></script>
<script src="P2_files/libs/quarto-html/quarto.js"></script>
<script src="P2_files/libs/quarto-html/popper.min.js"></script>
<script src="P2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="P2_files/libs/quarto-html/anchor.min.js"></script>
<link href="P2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="P2_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="P2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="P2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="P2_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#load-libraries" id="toc-load-libraries" class="nav-link active" data-scroll-target="#load-libraries">Load libraries</a></li>
  <li><a href="#load-dataset" id="toc-load-dataset" class="nav-link" data-scroll-target="#load-dataset">Load dataset</a></li>
  <li><a href="#choose-variables" id="toc-choose-variables" class="nav-link" data-scroll-target="#choose-variables">Choose variables</a></li>
  <li><a href="#construct-variables" id="toc-construct-variables" class="nav-link" data-scroll-target="#construct-variables">Construct variables</a>
  <ul class="collapse">
  <li><a href="#outcome-vehicle-availability" id="toc-outcome-vehicle-availability" class="nav-link" data-scroll-target="#outcome-vehicle-availability">Outcome: Vehicle availability</a></li>
  <li><a href="#predictor-number-of-children" id="toc-predictor-number-of-children" class="nav-link" data-scroll-target="#predictor-number-of-children">Predictor: Number of children</a></li>
  <li><a href="#predictor-number-of-seniors" id="toc-predictor-number-of-seniors" class="nav-link" data-scroll-target="#predictor-number-of-seniors">Predictor: Number of seniors</a></li>
  <li><a href="#predictor-presence-of-third-driver" id="toc-predictor-presence-of-third-driver" class="nav-link" data-scroll-target="#predictor-presence-of-third-driver">Predictor: Presence of third driver</a></li>
  <li><a href="#predictor-number-of-drivers-beyond-two" id="toc-predictor-number-of-drivers-beyond-two" class="nav-link" data-scroll-target="#predictor-number-of-drivers-beyond-two">Predictor: Number of drivers beyond two</a></li>
  <li><a href="#predictor-income" id="toc-predictor-income" class="nav-link" data-scroll-target="#predictor-income">Predictor: Income</a></li>
  <li><a href="#predictor-non-worker-driver" id="toc-predictor-non-worker-driver" class="nav-link" data-scroll-target="#predictor-non-worker-driver">Predictor: Non-worker driver</a></li>
  <li><a href="#predictor-density" id="toc-predictor-density" class="nav-link" data-scroll-target="#predictor-density">Predictor: Density</a></li>
  </ul></li>
  <li><a href="#prepare-data" id="toc-prepare-data" class="nav-link" data-scroll-target="#prepare-data">Prepare data</a>
  <ul class="collapse">
  <li><a href="#drop-the-variables-you-wont-be-using" id="toc-drop-the-variables-you-wont-be-using" class="nav-link" data-scroll-target="#drop-the-variables-you-wont-be-using">Drop the variables you won’t be using</a></li>
  <li><a href="#create-training-and-test-datasets" id="toc-create-training-and-test-datasets" class="nav-link" data-scroll-target="#create-training-and-test-datasets">Create training and test datasets</a></li>
  <li><a href="#create-dfidx-data" id="toc-create-dfidx-data" class="nav-link" data-scroll-target="#create-dfidx-data">Create dfidx data</a></li>
  </ul></li>
  <li><a href="#estimate-model" id="toc-estimate-model" class="nav-link" data-scroll-target="#estimate-model">Estimate model</a></li>
  <li><a href="#interpreting-model-results" id="toc-interpreting-model-results" class="nav-link" data-scroll-target="#interpreting-model-results">Interpreting model results</a>
  <ul class="collapse">
  <li><a href="#predicting-probabilities" id="toc-predicting-probabilities" class="nav-link" data-scroll-target="#predicting-probabilities">Predicting probabilities</a></li>
  </ul></li>
  <li><a href="#checking-model-reliability-and-accuracy" id="toc-checking-model-reliability-and-accuracy" class="nav-link" data-scroll-target="#checking-model-reliability-and-accuracy">Checking model reliability and accuracy</a></li>
  <li><a href="#your-challenge" id="toc-your-challenge" class="nav-link" data-scroll-target="#your-challenge">Your challenge:</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">P2: Vehicle Availability</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The purpose of this assignment is for you to get some experience estimating and interpreting a discrete choice model by</p>
<ul>
<li><p>Reading the documentation for the vehicle availability submodel of the Boston Region Metropolitan Planning Organization’s regional travel demand model (<a href="https://www.ctps.org/travel-demand-model">TDM23</a>),</p></li>
<li><p>Estimating a vehicle availability model using data using similar predictors to those in the TDM23 vehicle availability submodel and data from the 2017 National Household Travel Survey,</p></li>
<li><p>Proposing an alternative vehicle availability model for the 2017 National Household Travel Survey,</p></li>
<li><p>Comparing the accuracy and reliability of the two models,</p></li>
<li><p>Interpreting the model results to explain the influence that household and built-environment characteristics have on vehicle availability.</p></li>
</ul>
<section id="load-libraries" class="level2">
<h2 class="anchored" data-anchor-id="load-libraries">Load libraries</h2>
<p>This analysis uses the following packages:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlogit)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are also a couple of functions that may be helpful in working with the <code>mlogit</code> package in the <code>mlogit_helpers.R</code> file in the GitHub repo. You can load those by sourcing the file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">here</span>(<span class="st">"code"</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>     <span class="st">"mlogit_helpers.R"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And here’s a function that will be useful in selecting rows of a dataset based on their ID value not being in a specified list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="st">'%!in%'</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x,y)<span class="sc">!</span>(<span class="st">'%in%'</span>(x,y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-dataset" class="level2">
<h2 class="anchored" data-anchor-id="load-dataset">Load dataset</h2>
<p>This analysis uses household-level data from the 2017 National Household Travel Survey.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>hh_data <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data"</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                <span class="st">"NHTS"</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                <span class="st">"hhpub.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The NHTS also includes person-level, trip-level, and vehicle-level datasets. You could use these to construct household-level variables if you want to, but they aren’t included in the GitHub repository because the files are larger than 50 MB. To use those files, go to <a href="https://nhts.ornl.gov/assets/2016/download/csv.zip" class="uri">https://nhts.ornl.gov/assets/2016/download/csv.zip</a>, extract the downloaded files, and save the four csv files (hhpub, perpub, trippub, and vehpub) to the “data” subfolder within the “examples” folder.</p>
<p>Once you’ve done that, you can load person-level data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>person_data <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data"</span>,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"NHTS"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"perpub.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="choose-variables" class="level2">
<h2 class="anchored" data-anchor-id="choose-variables">Choose variables</h2>
<p>Refer to the TDM23 Structures and Performance report (<a href="https://ctps.org/pub/tdm23_sc/tdm23.1.0/TDM23_Structures%20and%20Performance.pdf" class="uri">https://ctps.org/pub/tdm23_sc/tdm23.1.0/TDM23_Structures%20and%20Performance.pdf</a>) for details on the vehicle availability sub-model of the TDM23 model (beginning on page 65).</p>
<p>They predict vehicle availability in one of three categories:</p>
<ul>
<li><p>Zero vehicles</p></li>
<li><p>Insufficient vehicles (fewer vehicles than drivers)</p></li>
<li><p>Sufficient vehicles (at least as many vehicles as drivers)</p></li>
</ul>
<p>We will use a similar outcome variable in our model.</p>
<p>Their model includes the following predictors:</p>
<ul>
<li><p>Household-level variables</p>
<ul>
<li><p>Number of workers</p></li>
<li><p>Number of children</p></li>
<li><p>Number of seniors</p></li>
<li><p>Number of drivers (beyond two)</p></li>
<li><p>Presence of a third driver</p></li>
<li><p>Presence of a non-worker driver</p></li>
<li><p>Low-income (income less than 200% of federal poverty level) (2010 dollars):</p>
<ul>
<li><p>One person: $22,288</p></li>
<li><p>Two person: $30,060</p></li>
<li><p>Three person: $35,137</p></li>
<li><p>Four person: $45,718</p></li>
<li><p>Five person: $55,036</p></li>
<li><p>Six person: $62,641</p></li>
<li><p>Seven person: $72,239</p></li>
<li><p>Eight or more person: $81,002</p></li>
</ul></li>
<li><p>High-income (income greater than $100,000 in 2010 dollars)</p></li>
</ul></li>
<li><p>Neighborhood-level variables</p>
<ul>
<li><p>CBD or dense urban</p>
<ul>
<li><p>CBD defined as a zone with multiple heavy rail stations within a 1/2 mile</p></li>
<li><p>Dense urban defined as a zone with at least 10,000 people or jobs per square mile</p></li>
</ul></li>
<li><p>Intersection density</p></li>
<li><p>Suburban or rural</p>
<ul>
<li>Defined as a zone with fewer than 5,000 people or jobs per square mile (suburban zones have bus service and rural zones do not)</li>
</ul></li>
<li><p>Ratio of transit accessibility to highway accessibility</p>
<ul>
<li>The number of jobs accessible within 30 minutes by transit divided by the number of jobs accessible within 30 minutes by car.</li>
</ul></li>
</ul></li>
</ul>
<p>For my initial model, I will follow this approach as closely as possible. The public NHTS dataset does not have information on employment density, intersection density, or accessibility, so I will estimate a model with the same outcome as the TDM23 model, using the following predictors:</p>
<ul>
<li><p>Household-level variables</p>
<ul>
<li><p>Number of workers</p></li>
<li><p>Number of children</p></li>
<li><p>Number of seniors</p></li>
<li><p>Number of drivers (beyond two)</p></li>
<li><p>Presence of a third driver</p></li>
<li><p>Presence of a non-worker driver</p></li>
<li><p>Low-income (income less than 200% of federal poverty level - adjusted based on available categories) (2017 dollars):</p>
<ul>
<li><p>One person: $25,000</p></li>
<li><p>Two or three person: $35,000</p></li>
<li><p>Four or five person: $50,000</p></li>
<li><p>Six or seven person: $75,000</p></li>
<li><p>Eight or more person: $100,000</p></li>
</ul></li>
<li><p>High-income (income greater than $125,000 in 2017 dollars)</p></li>
</ul></li>
<li><p>Neighborhood-level variables</p>
<ul>
<li><p>Density greater than 10,000 residents per square mile</p></li>
<li><p>Density less than 7,000 residents per square mile</p></li>
</ul></li>
</ul>
</section>
<section id="construct-variables" class="level2">
<h2 class="anchored" data-anchor-id="construct-variables">Construct variables</h2>
<p>You can browse descriptions of the variables available from the 2017 NHTS here: <a href="https://nhts.ornl.gov/tables09/CodebookBrowser.aspx" class="uri">https://nhts.ornl.gov/tables09/CodebookBrowser.aspx</a></p>
<p>Some of these variables are directly available. We’ll need to construct some of the others.</p>
<p>The variables we have in the household file that we can use are:</p>
<ul>
<li><p>WRKCOUNT: The number of workers in the household. This corresponds directly to the number of workers variable.</p></li>
<li><p>DRVRCNT: The number of drivers in the household. We can use this to calculate the number of drivers beyond two, the presence of a third driver, and whether the number of vehicles per driver is less than, greater than, or equal to one.</p></li>
<li><p>HHSIZE: The number of people in the household. We can use this to calculate the number of children in the household and whether a household is low income.</p></li>
<li><p>NUMADULT: The number of adults in the household. We can use this to calculate the number of children in the household.</p></li>
<li><p>HHFAMINC: The household income, in one of 11 categories. We can use this to identify households as high income or low income.</p></li>
<li><p>HBPPOPDN: The density of the household’s census block group. We can use this to classify household’s neighborhoods as high- or low-density.</p></li>
<li><p>HOUSEID: A unique identifier for each household. We’ll need to use this to match households to any variables we construct using person-level data.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>hh_data <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(WRKCOUNT,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>         DRVRCNT,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>         HHVEHCNT,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>         HHSIZE,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>         NUMADLT,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>         HHFAMINC,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>         HBPPOPDN,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>         HOUSEID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will need the person file to get the number of seniors in each household and to identify households in which all drivers are workers (the household file has the number of workers and the number of drivers, but does not necessarily tell us whether the workers and drivers are the same people).</p>
<p>We will need to use the following variables from the person file:</p>
<ul>
<li><p>HOUSEID: A unique identifier for each household. We’ll need to use this to match households to the data from the household-level dataset.</p></li>
<li><p>R_AGE: The person’s age. We can use this to identify which household members are seniors (which we’ll define as those older than 64).</p></li>
<li><p>WORKER: Whether the person is a worker.</p></li>
<li><p>DRIVER: Whether the person is a driver.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>person_data <span class="ot">&lt;-</span> person_data <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(HOUSEID,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>         R_AGE,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>         WORKER,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>         DRIVER)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="outcome-vehicle-availability" class="level3">
<h3 class="anchored" data-anchor-id="outcome-vehicle-availability">Outcome: Vehicle availability</h3>
<p>Our vehicle availability outcome will be a categorical variable with three categories:</p>
<ul>
<li><p>Zero vehicles</p></li>
<li><p>Insufficient vehicles (fewer vehicles than drivers)</p></li>
<li><p>Sufficient vehicles (at least as many vehicles as drivers)</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>hh_data <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">veh_avail =</span> <span class="fu">case_when</span>(HHVEHCNT <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Zero"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                               DRVRCNT <span class="sc">&gt;</span> HHVEHCNT <span class="sc">~</span> <span class="st">"Insuff."</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                               <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Suff."</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predictor-number-of-children" class="level3">
<h3 class="anchored" data-anchor-id="predictor-number-of-children">Predictor: Number of children</h3>
<p>The household dataset has the number of people and the number of adults in each household, so we can take the difference as the number of children.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>hh_data <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_child =</span> HHSIZE <span class="sc">-</span> NUMADLT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predictor-number-of-seniors" class="level3">
<h3 class="anchored" data-anchor-id="predictor-number-of-seniors">Predictor: Number of seniors</h3>
<p>We can get the number of seniors in each household from the person file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>n_seniors <span class="ot">&lt;-</span> person_data <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_senior =</span> R_AGE <span class="sc">&gt;</span> <span class="dv">64</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(HOUSEID) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_seniors =</span> <span class="fu">sum</span>(is_senior))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>hh_data <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(n_seniors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predictor-presence-of-third-driver" class="level3">
<h3 class="anchored" data-anchor-id="predictor-presence-of-third-driver">Predictor: Presence of third driver</h3>
<p>We want a binary variable for whether there are more than two drivers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>hh_data <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">three_drivers =</span> DRVRCNT <span class="sc">&gt;</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predictor-number-of-drivers-beyond-two" class="level3">
<h3 class="anchored" data-anchor-id="predictor-number-of-drivers-beyond-two">Predictor: Number of drivers beyond two</h3>
<p>And then for those households who do have more than two drivers, we want to know how many more they have.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>hh_data <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_extra_drivers =</span> <span class="fu">ifelse</span>(three_drivers, DRVRCNT <span class="sc">-</span> <span class="dv">2</span>, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predictor-income" class="level3">
<h3 class="anchored" data-anchor-id="predictor-income">Predictor: Income</h3>
<p>Low-income designation depends on both income and household size. All households with income more than $125,000 are designated as high income.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>hh_data <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">HHFAMINC =</span> <span class="fu">as.numeric</span>(HHFAMINC)) <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(HHFAMINC <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">income =</span> <span class="fu">case_when</span>(HHFAMINC <span class="sc">&lt;</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"low"</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                             HHFAMINC <span class="sc">&lt;</span> <span class="dv">5</span> <span class="sc">&amp;</span> HHSIZE <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"low"</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                             HHFAMINC <span class="sc">&lt;</span> <span class="dv">6</span> <span class="sc">&amp;</span> HHSIZE <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"low"</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                             HHFAMINC <span class="sc">&lt;</span> <span class="dv">7</span> <span class="sc">&amp;</span> HHSIZE <span class="sc">&gt;</span> <span class="dv">5</span> <span class="sc">~</span> <span class="st">"low"</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                             HHFAMINC <span class="sc">&lt;</span> <span class="dv">8</span> <span class="sc">&amp;</span> HHSIZE <span class="sc">&gt;</span> <span class="dv">7</span> <span class="sc">~</span> <span class="st">"low"</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                             HHFAMINC <span class="sc">&gt;</span> <span class="dv">8</span> <span class="sc">~</span> <span class="st">"high"</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                            <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"medium"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">income =</span> <span class="fu">factor</span>(income, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"medium"</span>, <span class="st">"low"</span>, <span class="st">"high"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predictor-non-worker-driver" class="level3">
<h3 class="anchored" data-anchor-id="predictor-non-worker-driver">Predictor: Non-worker driver</h3>
<p>Is there anyone in the household who is a driver, but not a worker?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>non_work_driver <span class="ot">&lt;-</span> person_data <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">non_work_driver =</span> WORKER <span class="sc">==</span> <span class="st">"02"</span> <span class="sc">&amp;</span> DRIVER <span class="sc">==</span> <span class="st">"01"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(HOUSEID) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">non_work_driver =</span> <span class="fu">max</span>(non_work_driver))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>hh_data <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(non_work_driver)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(HOUSEID)`</code></pre>
</div>
</div>
</section>
<section id="predictor-density" class="level3">
<h3 class="anchored" data-anchor-id="predictor-density">Predictor: Density</h3>
<p>Density will be in one of three categories: High, medium, and low.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>hh_data <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(HBPPOPDN <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density =</span> <span class="fu">case_when</span>(HBPPOPDN <span class="sc">&lt;</span> <span class="dv">7000</span> <span class="sc">~</span> <span class="st">"Low"</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                             HBPPOPDN <span class="sc">&lt;</span> <span class="dv">10000</span> <span class="sc">~</span> <span class="st">"High"</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                             <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Medium"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="prepare-data" class="level2">
<h2 class="anchored" data-anchor-id="prepare-data">Prepare data</h2>
<section id="drop-the-variables-you-wont-be-using" class="level3">
<h3 class="anchored" data-anchor-id="drop-the-variables-you-wont-be-using">Drop the variables you won’t be using</h3>
<p>We have some variables in our dataset that we used to construct the variables we needed, but we don’t need them any more. We’ll keep only the variable we’ll be including in our model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>hh_data <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(HOUSEID,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>         veh_avail,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>         WRKCOUNT,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>         n_child,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>         n_seniors,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>         n_extra_drivers,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>         three_drivers,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>         non_work_driver,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>         income,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>         density)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-training-and-test-datasets" class="level3">
<h3 class="anchored" data-anchor-id="create-training-and-test-datasets">Create training and test datasets</h3>
<p>We will train the model on half of our sample and use the other half to test our model.</p>
<p>I’m setting a random number seed so that my randomly-selected variable will be the same every time. You can choose any number as your seed (I’m using my childhood phone number! It was a land line!). In your own work, you should use a different seed than I’m using here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3775668</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>hh_data_train_ids <span class="ot">&lt;-</span> <span class="fu">sample</span>(hh_data<span class="sc">$</span>HOUSEID, </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">size =</span> <span class="fu">ceiling</span>(<span class="fu">nrow</span>(hh_data)<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>hh_data_train <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(HOUSEID <span class="sc">%in%</span> hh_data_train_ids)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>hh_data_test <span class="ot">&lt;-</span> hh_data <span class="sc">|&gt;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(HOUSEID <span class="sc">%!in%</span> hh_data_train_ids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-dfidx-data" class="level3">
<h3 class="anchored" data-anchor-id="create-dfidx-data">Create dfidx data</h3>
<p>The mlogit package is useful for multinomial logistic regression, but it requires the data to be in a particular format (called dfidx) that includes information about which alternatives are available in each choice situation. In this case, all alternatives are available to all choosers in all choice situations and all variables describe the chooser and choice situation rather than the alternative, so you can use the function <code>fn_make_dfidx</code> in the <code>mlogit_helpers.R</code> file to reformat your data into the format that the <code>mlogit</code> package requires.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>veh_dfidx_train <span class="ot">&lt;-</span> <span class="fu">fn_make_dfidx</span>(hh_data_train,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"HOUSEID"</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"veh_avail"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>veh_dfidx_test <span class="ot">&lt;-</span> <span class="fu">fn_make_dfidx</span>(hh_data_test,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"HOUSEID"</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"veh_avail"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="estimate-model" class="level2">
<h2 class="anchored" data-anchor-id="estimate-model">Estimate model</h2>
<p>Now we can estimate our multinomial logistic regression using the <code>mlogit</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>model_veh <span class="ot">&lt;-</span> <span class="fu">mlogit</span>(choice <span class="sc">~</span> <span class="dv">0</span> <span class="sc">|</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                      WRKCOUNT <span class="sc">+</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                      n_child <span class="sc">+</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                      n_seniors <span class="sc">+</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                      n_extra_drivers <span class="sc">+</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                      three_drivers <span class="sc">+</span> </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                      non_work_driver <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                      income <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                      density <span class="sc">|</span> <span class="dv">0</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                           veh_dfidx_train,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                           <span class="at">reflevel =</span> <span class="st">"Suff."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we can take a look at the results of our model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_veh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
mlogit(formula = choice ~ 0 | WRKCOUNT + n_child + n_seniors + 
    n_extra_drivers + three_drivers + non_work_driver + income + 
    density | 0, data = veh_dfidx_train, reflevel = "Suff.", 
    method = "nr")

Frequencies of alternatives:choice
   Suff.  Insuff.     Zero 
0.884649 0.068536 0.046814 

nr method
9 iterations, 0h:0m:8s 
g'(-H)^-1g = 8.34E-05 
successive function values within tolerance limits 

Coefficients :
                           Estimate Std. Error  z-value  Pr(&gt;|z|)    
(Intercept):Insuff.       -4.251500   0.071869 -59.1565 &lt; 2.2e-16 ***
(Intercept):Zero           0.197101   0.088949   2.2159  0.026699 *  
WRKCOUNT:Insuff.           0.414381   0.031556  13.1316 &lt; 2.2e-16 ***
WRKCOUNT:Zero             -3.181995   0.068991 -46.1218 &lt; 2.2e-16 ***
n_child:Insuff.            0.201859   0.018019  11.2026 &lt; 2.2e-16 ***
n_child:Zero              -0.119276   0.042279  -2.8212  0.004785 ** 
n_seniors:Insuff.          0.324414   0.024246  13.3802 &lt; 2.2e-16 ***
n_seniors:Zero            -0.546331   0.048072 -11.3649 &lt; 2.2e-16 ***
n_extra_drivers:Insuff.    0.257564   0.059582   4.3229  1.54e-05 ***
n_extra_drivers:Zero       0.420559   0.432279   0.9729  0.330609    
three_driversTRUE:Insuff.  0.742189   0.084595   8.7734 &lt; 2.2e-16 ***
three_driversTRUE:Zero     0.602056   0.577225   1.0430  0.296940    
non_work_driver:Insuff.    1.220285   0.054960  22.2030 &lt; 2.2e-16 ***
non_work_driver:Zero      -4.133704   0.073608 -56.1581 &lt; 2.2e-16 ***
incomelow:Insuff.          0.597000   0.037440  15.9453 &lt; 2.2e-16 ***
incomelow:Zero             1.989625   0.057955  34.3302 &lt; 2.2e-16 ***
incomehigh:Insuff.        -0.300225   0.049837  -6.0242  1.70e-09 ***
incomehigh:Zero            0.086375   0.122365   0.7059  0.480261    
densityLow:Insuff.        -0.333071   0.039392  -8.4553 &lt; 2.2e-16 ***
densityLow:Zero           -0.604069   0.059383 -10.1724 &lt; 2.2e-16 ***
densityMedium:Insuff.      0.780560   0.060495  12.9030 &lt; 2.2e-16 ***
densityMedium:Zero         1.500555   0.070757  21.2072 &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Log-Likelihood: -19848
McFadden R^2:  0.272 
Likelihood ratio test : chisq = 14831 (p.value = &lt; 2.22e-16)</code></pre>
</div>
</div>
</section>
<section id="interpreting-model-results" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-model-results">Interpreting model results</h2>
<p>The regression coefficients predict the <em>utility</em> of an alternative. The utility of an alternative relative to that of the other alternatives determines the probability of choosing that alternative. Looking the regression coefficient for the number of children is 0.2 for insufficient vehicles, and -0.12 for zero vehicles. This means that each additional child in a household increases the utility of having insufficient vehicles (relative to having sufficient vehicles) and decreases the utility of having zero vehicles (relative to having sufficient vehicles).</p>
<section id="predicting-probabilities" class="level3">
<h3 class="anchored" data-anchor-id="predicting-probabilities">Predicting probabilities</h3>
<p>For example, what would be the predicted vehicle availability for a household with:</p>
<ul>
<li><p>Two workers (WRKCOUNT = 2)</p></li>
<li><p>One senior (n_seniors = 1)</p></li>
<li><p>Three children (n_child = 3)</p></li>
<li><p>Three drivers (three_drivers = TRUE and n_extra_drivers = 1 and non_worker_driver = TRUE)</p></li>
<li><p>Low income (Income = “Low”)</p></li>
<li><p>Low density (density = “low”)</p></li>
</ul>
<p>The utility of being a zero-vehicle household would be:</p>
<p><span class="math display">\[
0.20 + 2(-3.18) + 3(-0.12) + 1(-0.55) + 2(0.42) + 1(0.60) + 1(-4.13) + 1(1.99) + 1(-0.60) = -8.37
\]</span></p>
<p>The utility of being a vehicle-insufficient household would be:</p>
<p><span class="math display">\[
-4.25 + 2(0.41) + 3(0.20) + 1(0.32) + 2(0.26) + 1(0.74) + 1(1.22) + 1(0.60) + 1(-0.33) = 0.24
\]</span></p>
<p>The utility of being a vehicle-sufficient household (the reference case) would be zero.</p>
<p>The probability of the household having zero vehicles would be:</p>
<p><span class="math display">\[
\frac{e^{-8.37}}{e^{-8.37}+e^{0.24}+e^0} = 0.0001
\]</span></p>
<p>The probability of the household having insufficient vehicles would be:</p>
<p><span class="math display">\[
\frac{e^{0.24}}{e^{-8.37}+e^{0.24}+e^0} = 0.56
\]</span></p>
<p>The probability of the household having sufficient vehicles would be:</p>
<p><span class="math display">\[
\frac{e^{0}}{e^{-8.59}+e^{0.22}+e^0} = 0.44
\]</span></p>
<p>We can do this calculation for all the households in our test dataset using the <code>predict()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>predicts_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_veh, veh_dfidx_test) <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"HOUSEID"</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">HOUSEID =</span> <span class="fu">as.numeric</span>(HOUSEID)) <span class="sc">|&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(hh_data_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And here are the first few rows of the resulting data frame, which shows the predicted probabilities from the model as well as the values for the predictors and the observed outcome.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(predicts_test) <span class="sc">|&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 10%">
<col style="width: 11%">
<col style="width: 5%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">HOUSEID</th>
<th style="text-align: right;">Suff.</th>
<th style="text-align: right;">Insuff.</th>
<th style="text-align: right;">Zero</th>
<th style="text-align: left;">veh_avail</th>
<th style="text-align: right;">WRKCOUNT</th>
<th style="text-align: right;">n_child</th>
<th style="text-align: right;">n_seniors</th>
<th style="text-align: right;">n_extra_drivers</th>
<th style="text-align: left;">three_drivers</th>
<th style="text-align: right;">non_work_driver</th>
<th style="text-align: left;">income</th>
<th style="text-align: left;">density</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">30000008</td>
<td style="text-align: right;">0.9760591</td>
<td style="text-align: right;">0.0228218</td>
<td style="text-align: right;">0.0011191</td>
<td style="text-align: left;">Suff.</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">medium</td>
<td style="text-align: left;">Low</td>
</tr>
<tr class="even">
<td style="text-align: right;">30000019</td>
<td style="text-align: right;">0.8723171</td>
<td style="text-align: right;">0.1048672</td>
<td style="text-align: right;">0.0228156</td>
<td style="text-align: left;">Suff.</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">low</td>
<td style="text-align: left;">Low</td>
</tr>
<tr class="odd">
<td style="text-align: right;">30000041</td>
<td style="text-align: right;">0.9817709</td>
<td style="text-align: right;">0.0170019</td>
<td style="text-align: right;">0.0012272</td>
<td style="text-align: left;">Suff.</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">high</td>
<td style="text-align: left;">Low</td>
</tr>
<tr class="even">
<td style="text-align: right;">30000089</td>
<td style="text-align: right;">0.9653308</td>
<td style="text-align: right;">0.0337973</td>
<td style="text-align: right;">0.0008719</td>
<td style="text-align: left;">Suff.</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">medium</td>
<td style="text-align: left;">Low</td>
</tr>
<tr class="odd">
<td style="text-align: right;">30000094</td>
<td style="text-align: right;">0.9587027</td>
<td style="text-align: right;">0.0148113</td>
<td style="text-align: right;">0.0264860</td>
<td style="text-align: left;">Suff.</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">medium</td>
<td style="text-align: left;">Low</td>
</tr>
<tr class="even">
<td style="text-align: right;">30000107</td>
<td style="text-align: right;">0.9365301</td>
<td style="text-align: right;">0.0451941</td>
<td style="text-align: right;">0.0182758</td>
<td style="text-align: left;">Suff.</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">medium</td>
<td style="text-align: left;">High</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="checking-model-reliability-and-accuracy" class="level2">
<h2 class="anchored" data-anchor-id="checking-model-reliability-and-accuracy">Checking model reliability and accuracy</h2>
<p>Now we can check how accurate and reliable our model is on the test dataset. First, I’ll designate the alternative with the highest predicted probability as the “most likely” choice.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>predicts_test <span class="ot">&lt;-</span> predicts_test <span class="sc">|&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">most_likely =</span> <span class="fu">case_when</span>((Suff. <span class="sc">&gt;</span> Insuff.) <span class="sc">&amp;</span> (Suff. <span class="sc">&gt;</span> Zero) <span class="sc">~</span> <span class="st">"Suff."</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                                 (Zero <span class="sc">&gt;</span> Insuff.) <span class="sc">&amp;</span> (Zero <span class="sc">&gt;</span> Suff.) <span class="sc">~</span> <span class="st">"Zero"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Insuff."</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, I need to convert the <code>most_likely</code> and <code>veh_avail</code> variables from strings to factors in order for the next part to work.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>predicts_test <span class="ot">&lt;-</span> predicts_test <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">most_likely =</span> <span class="fu">factor</span>(most_likely, </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Suff."</span>, <span class="st">"Insuff."</span>, <span class="st">"Zero"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">veh_avail =</span> <span class="fu">factor</span>(veh_avail,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Suff."</span>, <span class="st">"Insuff."</span>, <span class="st">"Zero"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">correct =</span> veh_avail <span class="sc">==</span> most_likely)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now, I can use the <code>confusionMatrix</code> function to generate some accuracy and reliability statistics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confusionMatrix</span>(<span class="at">data =</span> predicts_test<span class="sc">$</span>most_likely,</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">reference =</span> predicts_test<span class="sc">$</span>veh_avail)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction Suff. Insuff.  Zero
   Suff.   54778    4229  1469
   Insuff.   164     141     1
   Zero      316       1  1509

Overall Statistics
                                          
               Accuracy : 0.9013          
                 95% CI : (0.8989, 0.9036)
    No Information Rate : 0.8826          
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
                                          
                  Kappa : 0.3226          
                                          
 Mcnemar's Test P-Value : &lt; 2.2e-16       

Statistics by Class:

                     Class: Suff. Class: Insuff. Class: Zero
Sensitivity                0.9913       0.032258     0.50655
Specificity                0.2248       0.997167     0.99468
Pos Pred Value             0.9058       0.460784     0.82640
Neg Pred Value             0.7749       0.932105     0.97582
Prevalence                 0.8826       0.069815     0.04758
Detection Rate             0.8749       0.002252     0.02410
Detection Prevalence       0.9659       0.004888     0.02917
Balanced Accuracy          0.6080       0.514712     0.75061</code></pre>
</div>
</div>
<p>Interpreting the overall statistics (see the documentation for the ConfusionMatrix function here: <a href="https://cran.r-project.org/web/packages/caret/caret.pdf" class="uri">https://cran.r-project.org/web/packages/caret/caret.pdf</a>):</p>
<ul>
<li><p><strong>Accuracy</strong> is the percent of observations (in this case, households) that are correctly classified.</p></li>
<li><p><strong>No-information rate</strong> is the accuracy you would achieve if you had no model and you just classified every household as the most common value.</p></li>
<li><p>The reported <strong>p-value</strong> is the likelihood that your model is performing better than a no-information model would.</p></li>
</ul>
<p>Interpreting the statistics by class:</p>
<ul>
<li><p><strong>Sensitivity</strong> is the percent of actual positives that are correctly identified (if it’s really a vehicle-insufficient household, how often will the mode say it is?)</p></li>
<li><p><strong>Specificity</strong> is the percent of actual negatives that are correctly identified (if it isn’t a vehicle-insufficient household, how often will the model say it isn’t?)</p></li>
<li><p><strong>Positive predictive value</strong> is the probability that a positive prediction will be correct (when the model predicts that a household is vehicle insufficient, how often is that prediction correct?)</p></li>
<li><p><strong>Negative predictive value</strong> is the probability that a negative prediction will be correct (when the model predicts that a household is <em>not</em> vehicle insufficient, how often is <em>that</em> prediction correct?)</p></li>
<li><p><strong>Prevalence</strong> is the percent of observations in this category</p></li>
<li><p><strong>Detection rate</strong> (as used by the author of the Confusion Matrix function) is the frequency with which this category is correctly predicted by the model.</p></li>
<li><p><strong>Detection prevalence</strong> (as used by the author of the Confusion Matrix function) is the frequency with which this category is predicted by the model.</p></li>
<li><p><strong>Balanced accuracy</strong> is the average of sensitivity and specificity</p></li>
</ul>
</section>
<section id="your-challenge" class="level2">
<h2 class="anchored" data-anchor-id="your-challenge">Your challenge:</h2>
<p>Redo the above analysis. Your regression results are likely to slightly different than the above because you’ll be using a different random number seed to draw the sample for your training dataset.</p>
<p>Can you estimate a vehicle availability model that performs better than this one? You might try a different set of predictor variables and/or a different form of the ones in this model (for example, you could use a continuous density variable, or more density categories).</p>
<p>Post your analysis code to GitHub and write a memo summarizing your work. Submit the memo via Canvas.</p>
<p>The memo should clearly document and explain all of your analysis decisions and interpreting the results of the preferred model to explain the influence that household and/or built-environment characteristics have on vehicle availability.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>